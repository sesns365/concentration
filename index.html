<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動物園專注力挑戰 - 物種識別</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定字體與整體排版 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh; /* 確保主體至少填滿視窗高度 */
            padding: 16px;
        }

        /* 顏色圓圈按鈕基本樣式 */
        .color-circle {
            flex-shrink: 0;
            width: 40px; /* 略微加大 */
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, border 0.2s;
            border: 4px solid transparent; 
        }
        
        /* 選中時的樣式 (移除藍色光暈，僅保留藍色邊框) */
        .color-circle.selected {
            transform: scale(1.1);
            border-color: #1d4ed8; 
        }

        /* 答案錯誤/正確樣式 */
        .color-circle.error { border-color: #ef4444; box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.4); }
        .color-circle.correct { border-color: #10b981; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.4); }

        /* 攤位複雜度樣式 - 使用 CSS 模擬完整且複雜的攤販背景 */
        .busy-scene {
            position: relative;
            height: 100%; /* 確保填滿父容器高度 */
            overflow: hidden; 
            background-color: #5d4037; 
        }
        
        /* 確保左右內容區塊高度一致 */
        #game-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            /* 讓 game-container 佔據整個頁面可用的垂直空間 */
            flex-grow: 1; 
        }
        
        /* 針對大螢幕的 2/3 vs 1/3 佈局 */
        @media (min-width: 1024px) {
            #game-container {
                grid-template-columns: 2fr 1fr; /* 2/3 vs 1/3 比例 */
            }
        }

        /* 左側容器確保內部場景填滿高度 */
        #source-display {
            display: flex;
            flex-direction: column;
            /* 讓左側高度與右側內容高度一致 */
            flex-grow: 1;
        }
        
        /* 左側場景容器佔據剩餘空間 */
        #busy-scene {
            flex-grow: 1; 
            position: relative;
        }


        /* 核心干擾物和目標線索的通用樣式 */
        .distraction-item { 
            position: absolute;
            font-size: 3rem; 
            opacity: 0.85; /* 輕微提高透明度，模擬底圖融入 */
            pointer-events: none;
            line-height: 1; 
            text-shadow: none; 
        }
        
        /* 核心線索容器：水果與圓圈相鄰排列 (用於定位群組) */
        .fruit-clue {
            position: absolute; 
            display: block; 
            width: 50px; 
            height: 50px;
            line-height: 1; 
            pointer-events: none; 
        }

        /* 核心線索：水果 Emoji (位於群組內) */
        .fruit-clue .fruit-emoji {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1; 
            font-size: 3rem; 
            text-shadow: none;
            z-index: 50; 
        }

        /* 水果旁邊的核心線索圓圈 (線索) - 固定偏移，確保歸屬清晰 */
        .fruit-clue .color-bubble {
            position: absolute; 
            top: 5%;      /* 固定在群組右上角 */
            right: -10px; 
            width: 25px; 
            height: 25px; 
            border-radius: 50%;
            border: 3px solid #000; 
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8); 
            z-index: 51; 
        }
        
        /* 強化核心線索的 Z-INDEX，確保它絕對不會被干擾物遮擋 */
        .fruit-clue {
            z-index: 100 !important; /* 確保核心線索在最上層 */
        }
        .fruit-clue .color-bubble {
            z-index: 101 !important; /* 確保圓圈標籤在最上層 */
        }


        /* 單色滑動選單樣式 */
        .single-color-picker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 8px;
            background-color: #f3f4f6;
            border-radius: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 140px; 
        }
        
        .arrow-button {
            background-color: #e5e7eb;
            color: #374151;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: bold;
            line-height: 1;
            transition: background-color 0.15s, transform 0.15s;
        }
        .arrow-button:hover:not(:disabled) {
            background-color: #d1d5db;
            transform: scale(1.05);
        }
        
        /* TTS 載入動畫 (不再使用) */
        .tts-loading:after {
            content: '.';
            animation: loading 1s steps(5, end) infinite;
        }
        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: '....'; }
        }
        
        /* Modal 樣式 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        
        /* 右側可點擊圖案樣式 */
        .target-label {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .target-label:hover {
            transform: scale(1.05);
        }

        /* 調整主容器以佔用更多垂直空間，減少滾動 */
        #app {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
    </style>
</head>
<body class="min-h-screen"> <!-- 確保 body 佔滿高度 -->

    <div id="app" class="w-full max-w-6xl bg-white p-4 sm:p-8 rounded-2xl shadow-2xl border border-gray-100 flex-grow">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-4 text-center">
            🦁 動物園大探險：物種識別任務 🦒
        </h1>
        
        <!-- 移除原頂部故事區，改為在 Modal 中顯示 -->
        <div class="text-xl font-bold text-center text-blue-600 mb-6">
            <span id="level-display">關卡載入中...</span>
        </div>
        
        
        <!-- 調整：在 lg 螢幕上，左側佔 2/3 寬度，右側佔 1/3 寬度 -->
        <div id="game-container" class="gap-6 sm:gap-10">
            
            <!-- 左側：複雜又分散注意力的場景（資訊來源） -->
            <div id="source-display" class="p-0 bg-yellow-50 rounded-xl border-4 border-yellow-300 shadow-inner overflow-hidden">
                <h2 id="source-title" class="text-xl sm:text-2xl font-bold text-yellow-800 p-4 border-b border-yellow-300 bg-yellow-100">
                    目標：找出右側目標物旁邊的顏色標籤
                </h2>
                
                <div id="busy-scene" class="busy-scene">
                    <div id="mixed-items-container" class="absolute top-0 left-0 w-full h-full">
                    </div>
                </div>
                
            </div>

            <!-- 右側：挑戰區 (作答區) - 寬度縮小 -->
            <div id="answer-panel" class="p-4 sm:p-6 bg-blue-50 rounded-xl border-4 border-blue-300 shadow-inner flex flex-col flex-grow">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">
                    右側：挑戰序列（請點擊箭頭選出正確的顏色）
                </h2>
                <div id="challenge-input" class="space-y-3"> <!-- 修正: space-y-4 改為 space-y-3，更緊湊 -->
                    <!-- 挑戰目標和顏色選單將由 JS 渲染至此 -->
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="check-button" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-150 shadow-md shadow-green-300 active:shadow-none active:translate-y-0.5 disabled:bg-gray-400">
                        ✅ 檢查答案
                    </button>
                    <button id="reset-button" class="sm:w-auto bg-gray-300 text-gray-800 py-3 px-6 rounded-xl font-bold text-lg hover:bg-gray-400 transition duration-150 shadow-md active:shadow-none active:translate-y-0.5">
                        🔄 重玩本關
                    </button>
                </div>
                
                <div id="message-box" class="mt-6 p-4 text-center text-xl font-semibold rounded-lg hidden border-2">
                    <!-- 遊戲訊息與結果顯示區 (僅用於錯誤提示) -->
                </div>
            </div>

        </div>
        
    </div>
    
    <!-- 故事說明 Modal (新流程：開場就彈出) -->
    <div id="story-modal" class="modal-overlay open">
        <div id="story-modal-content" class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-md w-full transform scale-100 transition-transform duration-300">
            <h3 id="modal-story-title" class="text-3xl font-extrabold text-purple-700 mb-4">任務說明</h3>
            <p id="modal-story-text" class="text-xl text-gray-700 mb-6"></p>
            <button id="story-modal-tts-button" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold text-sm hover:bg-purple-600 transition duration-150 mb-4 disabled:bg-gray-400">
                🔊 報讀故事
            </button>
            <button id="start-challenge-button" class="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold text-lg hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-300">
                🚀 開始挑戰
            </button>
        </div>
    </div>

    <!-- 成功破關 Modal 畫面 -->
    <div id="success-modal" class="modal-overlay">
        <div id="modal-content" class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full transform scale-90 transition-transform duration-300">
            <div class="text-7xl mb-4 animate-bounce">🏆</div>
            <h3 id="modal-title" class="text-3xl font-extrabold text-green-700 mb-2"></h3>
            <p id="modal-message" class="text-xl text-gray-700 mb-6"></p>
             <button id="modal-tts-button" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold text-sm hover:bg-purple-600 transition duration-150 mb-4 disabled:bg-gray-400">
                🔊 報讀故事
            </button>
            <button id="modal-action-button" class="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold text-lg hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-300">
                <!-- 按鈕文字將由 JS 設定 -->
            </button>
        </div>
    </div>

    <!-- 成功音效元素 (使用 Tone.js 模擬) -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.71/build/Tone.min.js"></script>

    <script>
        // ----------------------------------------------------
        // 1. 遊戲資料與設定 (已更新為動物園主題 - 5 關)
        // ----------------------------------------------------

        // 基礎目標數據 (名稱, Emoji/圖案)
        const OBJECT_DATA = [
            // Level 1: 亞洲猛獸區 (Big Cats & Mammals)
            { type: 'jungle', name: '獅子', emoji: '🦁' }, 
            { type: 'jungle', name: '老虎', emoji: '🐯' }, 
            { type: 'jungle', name: '大象', emoji: '🐘' }, 
            { type: 'jungle', name: '長頸鹿', emoji: '🦒' }, 
            { type: 'jungle', name: '熊貓', emoji: '🐼' }, 
            { type: 'jungle', name: '犀牛', emoji: '🦏' }, 
            { type: 'jungle', name: '猩猩', emoji: '🦍' }, 
            // Level 2: 兩棲爬蟲館 (Reptiles & Amphibians)
            { type: 'reptile', name: '鱷魚', emoji: '🐊' }, 
            { type: 'reptile', name: '蛇', emoji: '🐍' }, 
            { type: 'reptile', name: '烏龜', emoji: '🐢' },
            { type: 'reptile', name: '變色龍', emoji: '🦎' },
            { type: 'reptile', name: '青蛙', emoji: '🐸' },
            { type: 'reptile', name: '蝸牛', emoji: '🐌' },
            { type: 'reptile', name: '蜘蛛', emoji: '🕷️' }, 
            // Level 3: 鳥類棲息地 (Birds)
            { type: 'bird', name: '企鵝', emoji: '🐧' }, 
            { type: 'bird', name: '鸚鵡', emoji: '🦜' }, 
            { type: 'bird', name: '貓頭鷹', emoji: '🦉' }, 
            { type: 'bird', name: '老鷹', emoji: '🦅' }, 
            { type: 'bird', name: '孔雀', emoji: '🦚' }, 
            { type: 'bird', name: '火雞', emoji: '🦃' }, 
            { type: 'bird', name: '天鵝', emoji: '🦢' }, 
            // Level 4: 海洋生物館 (Marine Life)
            { type: 'marine', name: '鯨魚', emoji: '🐳' }, 
            { type: 'marine', name: '海豚', emoji: '🐬' }, 
            { type: 'marine', name: '鯊魚', emoji: '🦈' }, 
            { type: 'marine', name: '章魚', emoji: '🐙' }, 
            { type: 'marine', name: '海星', emoji: '⭐' }, // 修正：將 '🫧' 氣泡替換為 '⭐' 海星
            { type: 'marine', name: '螃蟹', emoji: '🦀' }, 
            { type: 'marine', name: '魚', emoji: '🐠' }, 
            // Level 5: 珍稀保育動物 (Rare Species)
            { type: 'rare', name: '狐狸', emoji: '🦊' }, 
            { type: 'rare', name: '無尾熊', emoji: '🐨' }, 
            { type: 'rare', name: '猴子', emoji: '🐒' }, 
            { type: 'rare', name: '兔子', emoji: '🐇' }, 
            { type: 'rare', name: '松鼠', emoji: '🐿️' }, 
            { type: 'rare', name: '狗', emoji: '🐕' }, 
            { type: 'rare', name: '駱駝', emoji: '🐪' }, 
        ];

        // 顏色選項 (Hex 值)
        const COLOR_OPTIONS = [
            { hex: '#ef4444', name: '紅色' },    
            { hex: '#facc15', name: '黃色' },    
            { hex: '#a855f7', name: '紫色' },    
            { hex: '#4ade80', name: '綠色' },    
            { hex: '#f97316', name: '橘色' },    
            { hex: '#3b82f6', name: '藍色' },    
            { hex: '#ec4899', name: '粉色' },    
        ];
        
        // 額外干擾物 (動物園/自然主題相關)
        const DISTRACTOR_POOL = ['🌳', '🌴', '🌿', '🪵', '🍄', '💦', '🪨', '⛺', '🧭', '🗺️', '🐾', '🦴', '🥕', '🍎', '🧺', '🗑️', '🔔', '🚧', '🛑', '🐒', '🦋', '🐞', '🦗', '🦟', '🔑', '📝', '🌡️', '🔦'];

        const BG_COLOR_PALETTES = [
            { main: '#38761d', secondary: '#6aa84f' }, // 叢林綠/猛獸區 (Level 1)
            { main: '#525252', secondary: '#737373' }, // 石頭灰/爬蟲館 (Level 2)
            { main: '#87ceeb', secondary: '#f7f2b9' }, // 天空藍/鳥類 (Level 3)
            { main: '#1e3a8a', secondary: '#3b82f6' }, // 深海藍/海洋 (Level 4)
            { main: '#d59459', secondary: '#e6ccb3' }, // 沙漠/草原棕 (Level 5)
        ];
        
        // 關卡故事線 (精簡至 5 關)
        const LEVEL_CONFIGS = [
            null, 
            { level: 1, distractorCount: 20, totalItems: 27, title: "亞洲猛獸區：核心物種識別",
              story: "🦁 歡迎來到動物園的第一區！<b>猛獸區</b>的叢林裡危機四伏，管理員在七種關鍵的<b>大型物種</b>旁貼上了顏色標籤。請你幫助我們，在茂密的叢林中找出這些動物的標籤顏色。", objectType: 'jungle' },
            { level: 2, distractorCount: 30, totalItems: 37, title: "兩棲爬蟲館：環境與生物分類",
              story: "🐍 進入陰暗潮濕的<b>爬蟲館</b>！這裡的七種<b>兩棲爬蟲類</b>隱藏在岩石和水窪中。你需要克服視覺干擾，仔細觀察並配對牠們各自的顏色標籤。", objectType: 'reptile' },
            { level: 3, distractorCount: 35, totalItems: 42, title: "鳥類棲息地：飛行與羽毛標記",
              story: "🦜 來到<b>鳥類棲息地</b>，各種鳥類圖案和羽毛散落一地。七種<b>核心鳥類物種</b>已貼上標籤，但被許多相似的圖案混淆。集中精神，找出這七種鳥的正確顏色！", objectType: 'bird' },
            { level: 4, distractorCount: 45, totalItems: 52, title: "海洋生物館：水下世界的偵查",
              story: "🐳 潛入深藍色的<b>海洋生物館</b>！這裡的七種<b>水生動物</b>在水草和氣泡的干擾下很難被定位。你需要像潛水員一樣保持專注，完成所有目標物的配對。", objectType: 'marine' },
            { level: 5, distractorCount: 50, totalItems: 57, title: "珍稀保育動物：細節確認",
              story: "🦘 這是最後一關，<b>珍稀保育區</b>的七個物種對動物園至關重要。在最高程度的干擾下，你的任務是零失誤地確認所有<b>珍稀物種</b>的顏色標籤！", objectType: 'rare' },
        ];
        
        const FINAL_STORY = {
            title: "🎉 恭喜！動物園探險完美達成！",
            message: "「太棒了！所有五個棲息地的物種識別任務都完美通過！」動物園園長高興地向你道謝。因為你的專注力和細心，所有的動物標籤都已確認無誤。你真是動物園最可靠的物種偵查專家！現在，盡情享受這趟成功的探險吧！",
            actionText: "🏆 重新開始亞洲猛獸區"
        };
        
        // ------------------------------------------------------------------
        
        let challengeSequence = [];
        let currentMapping = []; 
        let userSelections = []; 
        let userColorIndex = []; 
        let currentLevel = 1; 
        
        // ----------------------------------------------------
        // 2. DOM 元素取得
        // ----------------------------------------------------

        const mixedItemsContainerEl = document.getElementById('mixed-items-container');
        const challengeInputEl = document.getElementById('challenge-input');
        const checkButton = document.getElementById('check-button');
        const resetButton = document.getElementById('reset-button');
        const messageBoxEl = document.getElementById('message-box');
        const successModalEl = document.getElementById('success-modal');
        const modalContentEl = document.getElementById('modal-content');
        const modalTitleEl = document.getElementById('modal-title');
        const modalMessageEl = document.getElementById('modal-message');
        const modalActionButton = document.getElementById('modal-action-button');
        const modalTtsButton = document.getElementById('modal-tts-button'); 
        const levelDisplayEl = document.getElementById('level-display');
        const storyModalEl = document.getElementById('story-modal'); // 取得故事 Modal
        const modalStoryTitleEl = document.getElementById('modal-story-title');
        const modalStoryTextEl = document.getElementById('modal-story-text');
        const modalStoryTtsButton = document.getElementById('story-modal-tts-button');
        const startChallengeButton = document.getElementById('start-challenge-button');
        const sourceTitleEl = document.getElementById('source-title');
        const answerPanelEl = document.getElementById('answer-panel'); 
        
        // Audio Player 
        let audioContext;

        
        // ----------------------------------------------------
        // 3. 輔助工具 (TTS/音效/通用)
        // ----------------------------------------------------
        
        // Regex to match most common Emojis/symbols
        const EMOJI_REGEX = /(\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Modifier}|\p{Emoji_Modifier_Base})/gu;

        /** 語詞朗讀 (使用瀏覽器內建 TTS，速度快，零延遲) */
        function readWord(word) {
            if ('speechSynthesis' in window) {
                // 1. 過濾掉 Emoji/圖示
                let cleanWord = word.replace(EMOJI_REGEX, '').trim(); 
                
                // 2. 移除故事中的 HTML 標籤 (例如 <b>)
                cleanWord = cleanWord.replace(/<[^>]*>?/gm, '').trim(); 
                
                if (cleanWord === "") return; // 如果清空後是空字串則不報讀

                // 在開始新的語音前，停止任何正在播放的語音
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(cleanWord);
                utterance.lang = 'zh-TW'; 
                // 調整語速和音調，使其聽起來清晰快速
                utterance.rate = 1.5; 
                utterance.pitch = 1.0; 
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("瀏覽器不支援 Web Speech API。");
            }
        }

        /** 播放破關音效 (通用成功音) */
        function playSuccessSound() {
            try {
                // 由於 Tone.js 已經在 startChallenge() 中啟動，這裡只需調用
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 1, oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.2, level: 0.5 }
                }).toDestination();
                
                synth.triggerAttackRelease("C5", "8n");
                synth.triggerAttackRelease("G5", "8n", "+0.05");
                synth.triggerAttackRelease("C6", "8n", "+0.1");

            } catch (error) {
                console.error("無法播放音效，可能是瀏覽器限制或 Tone.js 錯誤:", error);
            }
        }
        
        /** 播放最終勝利音效 (拍手/歡呼) */
        function playFinalSuccessSound() {
            try {
                // 由於 Tone.js 已經在 startChallenge() 中啟動，這裡只需調用
                // 模擬拍手/鼓掌的聲音
                const clap = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.05 }
                }).toDestination();

                // 歡呼的音高
                const cheerSynth = new Tone.MembraneSynth({
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0.01, release: 0.5 }
                }).toDestination();

                // 快速鼓掌序列
                clap.triggerAttackRelease("8n", 0);
                clap.triggerAttackRelease("8n", "+0.1");
                clap.triggerAttackRelease("8n", "+0.2");

                // 歡呼聲
                cheerSynth.triggerAttackRelease("G4", "4n", "+0.3");
                cheerSynth.triggerAttackRelease("C5", "4n", "+0.6");

            } catch (error) {
                console.error("無法播放最終音效:", error);
                playSuccessSound(); // fallback
            }
        }


        /** 隨機打亂陣列 */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // ----------------------------------------------------
        // 4. 遊戲邏輯與函式
        // ----------------------------------------------------

        /** 產生本次挑戰的隨機目標序列和顏色配對 */
        function generateChallengeAndMapping() {
            const config = LEVEL_CONFIGS[currentLevel];
            
            // 根據關卡類型篩選目標物
            const objectPool = OBJECT_DATA.filter(obj => obj.type === config.objectType);
            
            // 修正 1：確保 objectPool 長度足以進行切片 (至少 7 個)
            if (objectPool.length < 7) {
                 console.error(`OBJECT_DATA 錯誤: Level ${currentLevel} (${config.objectType}) 類型項目不足 7 個.`);
                 // 這裡可以選擇回退到 Level 1 或停止遊戲
                 // 暫時強制回退到 Level 1 的數據
                 const defaultPool = OBJECT_DATA.filter(obj => obj.type === 'jungle');
                 let challengeTargets = [...defaultPool];
                 challengeTargets = challengeTargets.slice(0, 7); 
            } else {
                 let challengeTargets = [...objectPool];
                 challengeTargets = challengeTargets.slice(0, 7); 

                 // 隨機打亂顏色
                 const shuffledColors = [...COLOR_OPTIONS];
                 shuffleArray(shuffledColors);

                 // 建立目標物 -> 顏色 的隨機配對
                 currentMapping = challengeTargets.map((item, index) => ({
                    emoji: item.emoji,
                    name: item.name,
                    correctHex: shuffledColors[index].hex,
                    mathLabel: null 
                 }));

                 // 建立挑戰序列 (右側的題目)
                 challengeSequence = [...currentMapping];
                 shuffleArray(challengeSequence); 
            }
        }
        
        /** 檢查新位置是否與現有的核心線索重疊 */
        function isOverlapping(newPos, existingPositions, sceneWidth, sceneHeight) {
            // 修正: 將最小距離緩衝區提高到 48%，確保核心目標物絕對不重疊
            const minDistanceX = sceneWidth * 0.48; 
            const minDistanceY = sceneHeight * 0.48;

            // 轉換百分比位置到像素（近似值）
            const newX = newPos.left * sceneWidth / 100;
            const newY = newPos.top * sceneHeight / 100;
            
            for (const existing of existingPositions) {
                const existingX = existing.left * sceneWidth / 100;
                const existingY = existing.top * sceneHeight / 100;

                const dx = Math.abs(newX - existingX);
                const dy = Math.abs(newY - existingY);

                if (dx < minDistanceX && dy < minDistanceY) {
                    return true;
                }
            }
            return false;
        }

        /** 渲染左側的複雜場景（資訊來源） */
        function renderSourceDisplay() {
            const config = LEVEL_CONFIGS[currentLevel];
            const busySceneEl = document.getElementById('busy-scene');
            const mixedItemsContainerEl = document.getElementById('mixed-items-container');
            
            // 獲取場景尺寸，用於防重疊計算
            const sceneWidth = busySceneEl.clientWidth || 500;
            const sceneHeight = busySceneEl.clientHeight || 500;
            
            // 檢查 currentMapping 是否已成功生成
            if (!currentMapping || currentMapping.length === 0) {
                 // 如果 currentMapping 未成功生成，可能是 generateChallengeAndMapping 失敗
                 console.error("renderSourceDisplay 失敗: currentMapping 為空。無法渲染場景。");
                 mixedItemsContainerEl.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-red-500 text-2xl">錯誤：無法載入關卡目標物。請嘗試重玩。</div>';
                 return; 
            }


            // 1. 隨機複雜背景
            const randomPalette = BG_COLOR_PALETTES[currentLevel - 1] || BG_COLOR_PALETTES[0]; 
             busySceneEl.style.backgroundImage = `repeating-linear-gradient(
                ${Math.floor(Math.random() * 90)}deg,
                ${randomPalette.secondary} 0,
                ${randomPalette.secondary} 2px,
                ${randomPalette.main} 2px,
                ${randomPalette.main} 25px
            )`;
            busySceneEl.style.backgroundColor = randomPalette.main;
            
            mixedItemsContainerEl.innerHTML = '';
            
            const allItems = [];
            
            // 用來記錄已確定的核心線索位置
            const confirmedCluePositions = [];

            // 2. 核心線索 (帶圓圈的目標物) - 總共 7 組
            currentMapping.forEach((item, index) => {
                let pos;
                let attempts = 0;
                let validPosition = false;

                // 嘗試找尋不重疊的位置 (最多嘗試 100 次，避免渲染失敗)
                while (!validPosition && attempts < 100) {
                    pos = { 
                        top: Math.random() * 80 + 10, // 避免邊緣
                        left: Math.random() * 80 + 10 
                    };
                    pos.topPercent = `${pos.top}%`;
                    pos.leftPercent = `${pos.left}%`;

                    // 這裡使用更嚴格的碰撞偵測
                    if (!isOverlapping(pos, confirmedCluePositions, sceneWidth, sceneHeight)) {
                        validPosition = true;
                    }
                    attempts++;
                }

                if (validPosition) {
                    confirmedCluePositions.push(pos);
                } else {
                    // 如果找不到不重疊位置，則強制使用一個隨機位置 (不完美但必須顯示)
                    pos = { topPercent: `${Math.random() * 90 + 5}%`, leftPercent: `${Math.random() * 90 + 5}%` };
                }
                
                const rotation = Math.floor(Math.random() * 180) - 90; 
                const zIndex = Math.floor(Math.random() * 10) + 1; 
                
                const clueHtml = `
                    <div class="fruit-clue distraction-item" style="
                        top: ${pos.topPercent}; left: ${pos.leftPercent}; 
                        transform: translate(-50%, -50%) rotate(${rotation}deg);
                        font-size: 3rem; 
                        z-index: ${zIndex + 10}; 
                    ">
                        <span class="fruit-emoji"> 
                            ${item.emoji}
                        </span>
                        <div class="color-bubble" style="background-color: ${item.correctHex};"></div>
                    </div>
                `;
                allItems.push(clueHtml);
            });

            // 3. 渲染干擾物
            const distractorCount = config.totalItems - currentMapping.length;
            for (let i = 0; i < distractorCount; i++) {
                const useChallengeTargetAsDistractor = Math.random() < 0.2; 
                
                let emoji;

                if (useChallengeTargetAsDistractor) {
                    // 使用當前挑戰目標的 Emoji 作為干擾物
                    const targetPool = OBJECT_DATA.filter(obj => obj.type === config.objectType);
                    const randomTarget = targetPool[Math.floor(Math.random() * targetPool.length)];
                    
                    // 修正 2：增加 Null 檢查，避免在 targetPool 抽取失敗時崩潰
                    if (randomTarget && randomTarget.emoji) {
                         emoji = randomTarget.emoji;
                    } else {
                         emoji = DISTRACTOR_POOL[Math.floor(Math.random() * DISTRACTOR_POOL.length)];
                    }

                } else {
                    emoji = DISTRACTOR_POOL[Math.floor(Math.random() * DISTRACTOR_POOL.length)];
                }
                
                // 這裡的 Level 2 數字干擾邏輯已由數據結構解決，故保持不變
                
                const pos = { 
                    top: `${Math.random() * 90 + 5}%`, 
                    left: `${Math.random() * 90 + 5}%` 
                };

                const rotation = Math.floor(Math.random() * 180) - 90; 
                // 修正：將干擾物字體大小範圍從 2-5rem 略微擴大，使其看起來更像混亂的底圖
                const size = Math.floor(Math.random() * 3) + 2.5; 
                const zIndex = Math.floor(Math.random() * 10) + 1; 
                
                // 確保干擾物與核心線索使用相似的 z-index
                const distractorZIndex = zIndex; 

                const distractorHtml = `
                    <span class="distraction-item" style="
                        top: ${pos.top}; left: ${pos.left}; 
                        transform: translate(-50%, -50%) rotate(${rotation}deg); 
                        font-size: ${size}rem;
                        z-index: ${distractorZIndex}; 
                    ">
                        ${emoji}
                    </span>
                `;
                allItems.push(distractorHtml);
            }
            
            shuffleArray(allItems); 
            mixedItemsContainerEl.innerHTML = allItems.join('');

            levelDisplayEl.textContent = config.title;
            sourceTitleEl.textContent = `場景：${config.title}`;
        }

        /** 渲染右側的挑戰區與單色滑動選單 */
        function renderChallengeInput() {
            challengeInputEl.innerHTML = '';
            userSelections = challengeSequence.map(() => COLOR_OPTIONS[0].hex); // 預設為第一個顏色
            userColorIndex = challengeSequence.map(() => 0); // 預設索引為 0

            challengeSequence.forEach((target, index) => {
                const row = document.createElement('div');
                row.id = `input-row-${index}`;
                // 修正： space-y-2 sm:space-y-0 sm:space-x-4 p-3  -> space-y-1 sm:space-y-0 sm:space-x-2 p-2 
                row.className = 'flex flex-col sm:flex-row items-center justify-between space-y-1 sm:space-y-0 sm:space-x-2 p-2 bg-white transition-colors duration-300 rounded-xl shadow-lg border border-gray-200';
                
                const targetLabel = document.createElement('div');
                targetLabel.className = 'target-label flex items-center space-x-3 w-full sm:w-auto';
                
                // 右側只顯示目標物 Emoji，不顯示文字名稱
                targetLabel.innerHTML = `
                    <span class="text-3xl">${target.emoji}</span> <!-- 修正：移除 sm:text-4xl，統一縮小 -->
                `;
                
                // 新增：目標物點擊語音報讀 (使用內建 TTS)
                targetLabel.addEventListener('click', () => {
                    readWord(target.name);
                });


                const pickerWrapper = document.createElement('div');
                pickerWrapper.className = 'single-color-picker';

                // 左箭頭
                const leftArrow = document.createElement('button');
                leftArrow.className = 'arrow-button';
                leftArrow.textContent = '◀';
                leftArrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateColor(index, -1);
                });

                // 顏色圓圈
                const colorCircle = document.createElement('button');
                colorCircle.id = `picker-circle-${index}`;
                colorCircle.className = 'color-circle selected';
                colorCircle.style.backgroundColor = COLOR_OPTIONS[0].hex;
                
                // 右箭頭
                const rightArrow = document.createElement('button');
                rightArrow.className = 'arrow-button';
                rightArrow.textContent = '▶';
                rightArrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateColor(index, 1);
                });
                
                // 觸控滑動事件處理 (Swiping for mobile)
                let startX;
                colorCircle.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, {passive: true}); 

                colorCircle.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = endX - startX;
                    // 提高滑動閾值到 40px，讓點擊和滑動能區分
                    if (diff > 40) {
                        navigateColor(index, -1); // Swipe right (diff > 0) -> move to previous color (index -1)
                    } else if (diff < -40) {
                        navigateColor(index, 1); // Swipe left (diff < 0) -> move to next color (index +1)
                    }
                });


                pickerWrapper.appendChild(leftArrow);
                pickerWrapper.appendChild(colorCircle);
                pickerWrapper.appendChild(rightArrow);

                row.appendChild(targetLabel);
                row.appendChild(pickerWrapper);
                challengeInputEl.appendChild(row);
            });
        }

        /** 導航顏色選擇 (左右切換) */
        function navigateColor(index, direction) {
            let currentIndex = userColorIndex[index];
            currentIndex = (currentIndex + direction) % COLOR_OPTIONS.length;
            if (currentIndex < 0) {
                currentIndex = COLOR_OPTIONS.length - 1;
            }

            userColorIndex[index] = currentIndex;
            const selectedHex = COLOR_OPTIONS[currentIndex].hex;
            userSelections[index] = selectedHex;
            
            const circle = document.getElementById(`picker-circle-${index}`);
            circle.style.backgroundColor = selectedHex;
            circle.className = 'color-circle selected'; 
            messageBoxEl.classList.add('hidden'); 
        }


        /** 顯示破關 Modal */
        function showSuccessModal() {
            const isFinalLevel = currentLevel === (LEVEL_CONFIGS.length - 1);
            
            // 清除右側面板的錯誤背景色
            answerPanelEl.classList.remove('bg-red-200'); // 移除較深的錯誤色
            answerPanelEl.classList.add('bg-blue-50');
            
            // 重置 modal TTS 按鈕狀態
            modalTtsButton.disabled = false;
            modalTtsButton.textContent = '🔊 報讀故事';


            if (isFinalLevel) {
                modalTitleEl.textContent = FINAL_STORY.title;
                modalMessageEl.textContent = FINAL_STORY.message;
                modalActionButton.textContent = FINAL_STORY.actionText;
                modalActionButton.onclick = () => {
                    currentLevel = 1;
                    closeSuccessModalAndInitGame();
                };
                playFinalSuccessSound(); // 播放最終勝利音效
                readWord(FINAL_STORY.message); // 使用內建 TTS 報讀最終故事
                
            } else {
                modalTitleEl.textContent = `✅ ${LEVEL_CONFIGS[currentLevel].title} - 完成！`;
                modalMessageEl.textContent = `太棒了！您已在複雜的場景中成功提取所有資訊。教練需要你的幫助完成下一項任務！`; // 修正故事敘事者
                modalActionButton.textContent = `🚀 進入下一關 (Level ${currentLevel + 1})`;
                modalActionButton.onclick = levelUp;
                playSuccessSound(); // 播放單關成功音效
            }

            checkButton.disabled = true;
            successModalEl.classList.add('open');
            modalContentEl.classList.remove('scale-90');
            modalContentEl.classList.add('scale-100');
        }


        /** 檢查答案並提供反饋 */
        function checkAnswer() {
            messageBoxEl.classList.remove('hidden');
            answerPanelEl.classList.remove('bg-red-200'); // 檢查前先移除錯誤背景色
            answerPanelEl.classList.add('bg-blue-50');

            let correctCount = 0;
            let allCorrect = true;

            for (let i = 0; i < challengeSequence.length; i++) {
                // 找到對應的目標物 (基於 Emoji)
                const challengeEmoji = challengeSequence[i].emoji;
                // 注意：這裡必須使用 find，因為我們在 generateChallengeAndMapping 中為數學關卡添加了額外的 mathLabel 屬性
                const correctItem = currentMapping.find(item => item.emoji === challengeEmoji);
                const correctHex = correctItem ? correctItem.correctHex : null;

                const userHex = userSelections[i];
                const circle = document.getElementById(`picker-circle-${i}`);
                const rowEl = document.getElementById(`input-row-${i}`);
                
                // 重設單行狀態
                circle.classList.remove('error', 'correct');
                rowEl.classList.remove('bg-red-300'); // 移除單行錯誤顏色
                rowEl.classList.add('bg-white'); // 確保單行預設是白色

                if (userHex === correctHex) {
                    correctCount++;
                    circle.classList.add('correct');
                    circle.classList.remove('error');
                } else {
                    allCorrect = false;
                    circle.classList.add('error');
                    circle.classList.remove('correct');
                    rowEl.classList.remove('bg-white'); // 移除白色
                    rowEl.classList.add('bg-red-300'); // 修正：將更明顯的紅色標示加到單行
                }
            }

            if (allCorrect) {
                showSuccessModal();
            } else {
                // 答錯 - 顯示底部訊息，並將右側整個面板的背景變成更深的紅色
                answerPanelEl.classList.remove('bg-blue-50');
                answerPanelEl.classList.add('bg-red-200'); // 錯誤時，將整個右側面板變為較深的淺紅色

                messageBoxEl.className = 'mt-6 p-4 text-center text-xl font-semibold rounded-lg border-2 bg-red-400 border-red-600 text-white'; // 訊息框使用更深的紅，白色字
                messageBoxEl.textContent = `❌ 答錯了！您答對了 ${correctCount} 題。請再仔細觀察左側被干擾的場景！`;
            }
        }
        
        /** 隱藏破關畫面並重新初始化遊戲 */
        function closeSuccessModalAndInitGame() {
            successModalEl.classList.remove('open');
            modalContentEl.classList.remove('scale-100');
            modalContentEl.classList.add('scale-90');
            initGame();
        }
        
        /** 進入下一關 */
        function levelUp() {
            // 由於只有 5 關，這裡判斷是否進入下一關
            if (currentLevel < 5) { // 關卡 1 到 4
                currentLevel++;
                closeSuccessModalAndInitGame();
            } else { // 關卡 5 結束
                // 這裡其實不會執行，因為 Level 5 會觸發 Final Modal
                currentLevel = 1; 
                closeSuccessModalAndInitGame();
            }
        }
        
        /** 重玩本關 (Reset Button Handler) */
        function resetCurrentLevel() {
             closeSuccessModalAndInitGame();
        }
        
        /** 顯示故事 Modal */
        function showStoryModal(level) {
            const config = LEVEL_CONFIGS[level];
            modalStoryTitleEl.innerHTML = `Level ${level}: ${config.title}`; // 確保 Modal 標題顯示 Level
            modalStoryTextEl.innerHTML = config.story; // 使用 innerHTML 來顯示粗體
            storyModalEl.classList.add('open');
        }
        
        /** 隱藏故事 Modal */
        function hideStoryModal() {
            storyModalEl.classList.remove('open');
            // 確保停止任何正在播放的 TTS
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        /** 初始化或重設遊戲 */
        function initGame() {
            if (currentLevel < 1) currentLevel = 1;
            if (currentLevel > 5) currentLevel = 1; // 循環從第一關開始 (只有 5 關)

            generateChallengeAndMapping(); 
            userSelections = challengeSequence.map(() => COLOR_OPTIONS[0].hex); 
            userColorIndex = challengeSequence.map(() => 0);
            
            // 禁用互動直到故事 Modal 關閉
            checkButton.disabled = true;
            resetButton.disabled = true;
            messageBoxEl.classList.add('hidden');
            
            successModalEl.classList.remove('open'); 
            
            // 確保面板顏色正確
            answerPanelEl.classList.remove('bg-red-200');
            answerPanelEl.classList.add('bg-blue-50');
            
            // 渲染畫面，但先不開放互動
            renderSourceDisplay();
            renderChallengeInput();
            
            // 顯示故事 Modal
            showStoryModal(currentLevel);

            console.log(`遊戲已初始化至關卡 ${currentLevel}.`);
        }
        
        /** 啟動挑戰 (從故事 Modal 點擊後觸發) */
        function startChallenge() {
            hideStoryModal();
            checkButton.disabled = false;
            resetButton.disabled = false;

            // 在首次用戶互動時，強制啟動 Tone.js AudioContext
            try {
                Tone.start();
                console.log("Tone.js AudioContext started.");
            } catch (e) {
                console.error("Failed to start Tone.js AudioContext:", e);
            }
        }

        
        // ----------------------------------------------------
        // 5. 事件監聽器與啟動
        // ----------------------------------------------------

        checkButton.addEventListener('click', checkAnswer);
        resetButton.addEventListener('click', resetCurrentLevel);
        
        // 故事 Modal 的 TTS 按鈕 (使用內建 TTS)
        modalStoryTtsButton.addEventListener('click', () => {
             const story = modalStoryTextEl.textContent; // 這裡讀取 textContent，TTS 不會讀取 HTML tag
             if(story) readWord(story);
        });

        // 啟動挑戰按鈕
        startChallengeButton.addEventListener('click', startChallenge);
        
        // 成功 Modal 的 TTS 按鈕 (最終故事) (使用內建 TTS)
        modalTtsButton.addEventListener('click', () => {
             const message = modalMessageEl.textContent; // 這裡讀取 textContent，TTS 不會讀取 HTML tag
             if (message) readWord(message);
        });

        // 首次載入遊戲
        window.onload = initGame;
    </script>
</body>
</html>
